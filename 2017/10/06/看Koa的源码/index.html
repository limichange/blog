<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="nodejs,koa," />





  <link rel="alternate" href="/atom.xml" title="Limichange Blog" type="application/atom+xml" />






<meta name="description" content="说明如果你对说明没兴趣，可以直接看下面一章节。 起因是我看到了一篇招聘说明，上面要求应试者对koa的源码了如指掌。很惭愧，我虽然使用koa有一段时间了，但的确没有仔细的看过koa的源码。于是我就到网上搜索了一些关于koa深入的说明或教程。但很遗憾，大多数的文章较老，停留在Genetator的版本，或只是提及了几个关键的核心，并不全面，或是写得较为凌乱。 所以，为什么不自己写一篇呢？ 如果你已经使用">
<meta name="keywords" content="nodejs,koa">
<meta property="og:type" content="article">
<meta property="og:title" content="看Koa的源码">
<meta property="og:url" content="http://limichange.uedtoutiao.com/2017/10/06/看Koa的源码/index.html">
<meta property="og:site_name" content="Limichange Blog">
<meta property="og:description" content="说明如果你对说明没兴趣，可以直接看下面一章节。 起因是我看到了一篇招聘说明，上面要求应试者对koa的源码了如指掌。很惭愧，我虽然使用koa有一段时间了，但的确没有仔细的看过koa的源码。于是我就到网上搜索了一些关于koa深入的说明或教程。但很遗憾，大多数的文章较老，停留在Genetator的版本，或只是提及了几个关键的核心，并不全面，或是写得较为凌乱。 所以，为什么不自己写一篇呢？ 如果你已经使用">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://github.com/koajs/koa/blob/master/docs/middleware.gif">
<meta property="og:updated_time" content="2017-10-16T12:56:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="看Koa的源码">
<meta name="twitter:description" content="说明如果你对说明没兴趣，可以直接看下面一章节。 起因是我看到了一篇招聘说明，上面要求应试者对koa的源码了如指掌。很惭愧，我虽然使用koa有一段时间了，但的确没有仔细的看过koa的源码。于是我就到网上搜索了一些关于koa深入的说明或教程。但很遗憾，大多数的文章较老，停留在Genetator的版本，或只是提及了几个关键的核心，并不全面，或是写得较为凌乱。 所以，为什么不自己写一篇呢？ 如果你已经使用">
<meta name="twitter:image" content="https://github.com/koajs/koa/blob/master/docs/middleware.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: 'KZ8H31F2HO',
      apiKey: '7cce19690b59c1203a116bec55f8c201',
      indexName: 'index',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://limichange.uedtoutiao.com/2017/10/06/看Koa的源码/"/>





  <title>看Koa的源码 | Limichange Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-62558211-10', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9f94f824db823c51e97cc40b683db034";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Limichange Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://limichange.uedtoutiao.com/2017/10/06/看Koa的源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Limichange">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Limichange Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">看Koa的源码</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-06T16:09:19+08:00">
                2017-10-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>如果你对说明没兴趣，可以直接看下面一章节。</p>
<p>起因是我看到了一篇招聘说明，上面要求应试者对koa的源码了如指掌。很惭愧，我虽然使用koa有一段时间了，但的确没有仔细的看过koa的源码。于是我就到网上搜索了一些关于koa深入的说明或教程。但很遗憾，大多数的文章较老，停留在<code>Genetator</code>的版本，或只是提及了几个关键的核心，并不全面，或是写得较为凌乱。</p>
<p>所以，为什么不自己写一篇呢？</p>
<p>如果你已经使用koa一段时间了，且对一些API比较熟悉了，现在想更加的精进一些。又或是你是刚用koa的新手，想从中学些比较有用的知识。那么这篇文章很适合你。</p>
<p>接下来我会事无巨细的为你介绍koa的方方面面，尽量对每一个函数和变量进行说明。当然，我没有办法保证所有的说明都是对的，如果你发现了错误，请在最后面留言，我会尽快的修改。</p>
<p>那么，让我们开始吧 ：）</p>
<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>我们看的是2.3.0版本，我Fork了下来以保证和文章同步，因为这篇文章在未来也会过时。<br><a href="https://github.com/limichange/koa" target="_blank" rel="external">https://github.com/limichange/koa</a></p>
<h2 id="首先"><a href="#首先" class="headerlink" title="首先"></a>首先</h2><p>这个是官方的上手例子，简单记忆一下。如果你对代码中的<code>async</code>和<code>=&gt;</code>感到困惑，那么你需要先去学习一下<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference" target="_blank" rel="external">最新的js语法</a>。因为我们看的目前是最新版的koa，所以你可以忽略generator的知识，当然学一下也没有什么关系：）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</div><div class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</div><div class="line"></div><div class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</div><div class="line">  ctx.body = <span class="string">'Hello World'</span>;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
<p>我们接下来的内容将会从这个例子展开。</p>
<h2 id="找入口"><a href="#找入口" class="headerlink" title="找入口"></a>找入口</h2><p>首先要找到入口的文件，不然我们就不知道从何看起了。我们可以在koa包的<a href="https://github.com/limichange/koa/blob/master/package.json#L5" target="_blank" rel="external">package.json</a>里找到。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"lib/application.js"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了，我们找到入口的文件了，接着往下看。</p>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>让我们把目光转到<a href="https://github.com/limichange/koa/blob/master/lib/application.js" target="_blank" rel="external">lib/application.js</a>。首先大致的看一下文件，然后我们先把文件简化一下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 引入其他的模块</span></div><div class="line"><span class="keyword">const</span> Emitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Koa的Class定义</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Emitter</span> </span>&#123;</div><div class="line">  <span class="comment">// 具体的内容</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 一个辅助的函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">respond</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="comment">// 具体的内容</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样看起来就很清晰了。</p>
<p><a href="https://nodejs.org/dist/latest-v8.x/docs/api/events.html" target="_blank" rel="external">events</a>是nodejs的内置基本库。如果不是很熟悉，可以去看看官方的文档。</p>
<p>接着看这个Class的构造函数。让我们稍微还原一下文件，填上我们要看的内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 引入其他的模块</span></div><div class="line"><span class="keyword">const</span> response = <span class="built_in">require</span>(<span class="string">'./response'</span>);</div><div class="line"><span class="keyword">const</span> context = <span class="built_in">require</span>(<span class="string">'./context'</span>);</div><div class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'./request'</span>);</div><div class="line"><span class="keyword">const</span> Emitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Koa的Class定义</span></div><div class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Emitter</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.proxy = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">this</span>.middleware = [];</div><div class="line">    <span class="keyword">this</span>.subdomainOffset = <span class="number">2</span>;</div><div class="line">    <span class="keyword">this</span>.env = process.env.NODE_ENV || <span class="string">'development'</span>;</div><div class="line">    <span class="keyword">this</span>.context = <span class="built_in">Object</span>.create(context);</div><div class="line">    <span class="keyword">this</span>.request = <span class="built_in">Object</span>.create(request);</div><div class="line">    <span class="keyword">this</span>.response = <span class="built_in">Object</span>.create(response);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 其他的内容</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>看样子是初始化了一些内部的变量，我们挨个看看。其中的三个我们可以从文档中找到解释。</p>
<ul>
<li><code>env</code> 是运行时的环境变量，默认是<code>development</code></li>
<li><code>proxy</code> 如果使用代理模式的话，就设为<code>true</code></li>
<li><code>subdomainOffset</code> offset of .subdomains to ignore [2]</li>
</ul>
<p>另外<code>middleware</code>从名字可以看出来，是用来存储中间件的。至于是如何运作的，我们会在后面详细的分析下。</p>
<p>让我们看最后三个变量，这是为了向外部暴露一些内部的原型对象。使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="external"><code>Object.create</code></a>可以将原型复制一份。一开始我也对这三个变量感到困惑，为什么要这么做？于是我翻了一下koa的commit历史，找到了一次<a href="https://github.com/limichange/koa/commit/0be144211189c0ebd2ca059d7f1ee2e72b2ac6b9" target="_blank" rel="external">提交</a>。</p>
<blockquote>
<p>expose app-specific prototypes, cleanup/fix tests</p>
</blockquote>
<p>当然官方文档里也说了。</p>
<blockquote>
<p>app.context is the prototype from which ctx is created from. You may add additional properties to ctx by editing app.context. This is useful for adding properties or methods to ctx to be used across your entire app, which may be more performant (no middleware) and/or easier (fewer require()s) at the expense of relying more on ctx, which could be considered an anti-pattern.</p>
</blockquote>
<p>简单的说就是可以通过他添加一个全局的属性或者方法，这样比添加中间件方便而且性能更好。如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">app.context.db = db();</div><div class="line"></div><div class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(ctx.db);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们暂且不要管三个变量的里面的具体实现，后面会慢慢讲。<br>很好，我们现在把最初的构建流程弄清楚了。</p>
<h2 id="app-use"><a href="#app-use" class="headerlink" title="app.use"></a>app.use</h2><p>现在我们看看这一部分，<code>use</code>函数。我们通过他塞入中间件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</div><div class="line">  ctx.body = <span class="string">'Hello World'</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>轻松找到<a href="https://github.com/limichange/koa/blob/master/lib/application.js#L94-L115" target="_blank" rel="external">定义的地方</a>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">use(fn) &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function!'</span>);</div><div class="line">  <span class="keyword">if</span> (isGeneratorFunction(fn)) &#123;</div><div class="line">    deprecate(<span class="string">'Support for generators will be removed in v3. '</span> +</div><div class="line">              <span class="string">'See the documentation for examples of how to convert old middleware '</span> +</div><div class="line">              <span class="string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span>);</div><div class="line">    fn = convert(fn);</div><div class="line">  &#125;</div><div class="line">  debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</div><div class="line">  <span class="keyword">this</span>.middleware.push(fn);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先他检查了fn是不是一个Generator函数，中间件都是通过函数的方式传入的。然后看看你传入的是不是v1版本的中间件，警告你一下，并贴心的帮你转换到v2。未来转化的这部分会废弃掉，就不详细讲了，用到的<a href="https://github.com/koajs/convert#readme" target="_blank" rel="external">koa-convert</a>和<a href="https://github.com/ljharb/is-generator-function#readme" target="_blank" rel="external">is-generator-function</a>可以自己详细看。</p>
<p><a href="https://github.com/visionmedia/debug#readme" target="_blank" rel="external">debug</a>是很常用的调试库，功能很多，没有用过或不熟悉的一定要要看。</p>
<p><code>middleware</code>就是我们前面看到的那个变量，和我们想的一样，中间件都被存到这个数组里面了。</p>
<p>最后返回this，因此可以做链式的调用。像这样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app</div><div class="line">  .use(...)</div><div class="line">  .use(...)</div></pre></td></tr></table></figure>
<p>看样子这个函数，只是把中间件存了起来，并没有做什么特别的事情。</p>
<h2 id="app-listen"><a href="#app-listen" class="headerlink" title="app.listen"></a>app.listen</h2><p>最后一个部分就是<code>app.listen</code>了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.listen(<span class="number">3000</span>)</div></pre></td></tr></table></figure>
<p>这个函数就定义在<a href="https://github.com/limichange/koa/blob/master/lib/application.js#L65-L73" target="_blank" rel="external">Application的构造函数的下面</a>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * Shorthand for:</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  *    http.createServer(app.callback()).listen(...)</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * @param &#123;Mixed&#125; ...</span></div><div class="line"><span class="comment">  * @return &#123;Server&#125;</span></div><div class="line"><span class="comment">  * @api public</span></div><div class="line"><span class="comment">  */</span></div><div class="line">listen(...args) &#123;</div><div class="line">  debug(<span class="string">'listen'</span>);</div><div class="line">  <span class="keyword">const</span> server = http.createServer(<span class="keyword">this</span>.callback());</div><div class="line">  <span class="keyword">return</span> server.listen(...args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>是个快捷方式，把监听的流程简化了一下。这里就是用<a href="https://nodejs.org/dist/latest-v8.x/docs/api/http.html#http_http_createserver_requestlistener" target="_blank" rel="external"><code>http.createServer</code></a>创建了一个http的服务，把参数直接的传入到<code>server.listen</code>。我们需要关注的是<code>this.callback()</code>。</p>
<p>先大致的看一下<a href="https://github.com/limichange/koa/blob/master/lib/application.js#L117-L140" target="_blank" rel="external">callback的实现</a>。这里是整个koa的核心，是处理请求的地方。通过注释知道，这个函数是返回一个请求处理回调给nodejs的http使用，就前面listen里的用法。首先我们大致的理清里面的流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * Return a request handler callback</span></div><div class="line"><span class="comment">  * for node's native http server.</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * @return &#123;Function&#125;</span></div><div class="line"><span class="comment">  * @api public</span></div><div class="line"><span class="comment">  */</span></div><div class="line"></div><div class="line">callback() &#123;</div><div class="line">  <span class="comment">// 把中间件处理成一个函数</span></div><div class="line">  <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware);</div><div class="line"></div><div class="line">  <span class="comment">// 绑定默认的错误处理</span></div><div class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listeners(<span class="string">'error'</span>).length) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</div><div class="line"></div><div class="line">  <span class="comment">// 首先是原生的`req`和`res`传进来</span></div><div class="line">  <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 默认状态码是404</span></div><div class="line">    res.statusCode = <span class="number">404</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 然后创建ctx</span></div><div class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res);</div><div class="line"></div><div class="line">    <span class="comment">// 创建错误处理的函数</span></div><div class="line">    <span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err);</div><div class="line"></div><div class="line">    <span class="comment">// 响应处理</span></div><div class="line">    <span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx);</div><div class="line"></div><div class="line">    <span class="comment">// 调用on-finished库处理</span></div><div class="line">    onFinished(res, onerror);</div><div class="line"></div><div class="line">    <span class="comment">// 用中间件处理ctx，然后处理响应，最后捕捉错误</span></div><div class="line">    <span class="keyword">return</span> fn(ctx).then(handleResponse).catch(onerror);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// 返回处理函数</span></div><div class="line">  <span class="keyword">return</span> handleRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>TODO</p>
</blockquote>
<h3 id="createContext"><a href="#createContext" class="headerlink" title="createContext"></a>createContext</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">createContext(req, res) &#123;</div><div class="line">  <span class="comment">// 还记得开头看到的那个构造函数吗？里面最后的三行。这里就直接的使用了那三个对象。</span></div><div class="line">  <span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</div><div class="line">  <span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</div><div class="line">  <span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</div><div class="line"></div><div class="line">  <span class="comment">// 接下来就是各种赋值，把原生`req`和`res`存起来，给对象做别名。</span></div><div class="line">  context.app = request.app = response.app = <span class="keyword">this</span>;</div><div class="line">  context.req = request.req = response.req = req;</div><div class="line">  context.res = request.res = response.res = res;</div><div class="line">  request.ctx = response.ctx = context;</div><div class="line">  request.response = response;</div><div class="line">  response.request = request;</div><div class="line">  context.originalUrl = request.originalUrl = req.url;</div><div class="line"></div><div class="line">  <span class="comment">// 创建`cookies`，平时你的`keys`就是给这里用的。</span></div><div class="line">  context.cookies = <span class="keyword">new</span> Cookies(req, res, &#123;</div><div class="line">    keys: <span class="keyword">this</span>.keys,</div><div class="line">    secure: request.secure</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">// 然后就是ip的判断。</span></div><div class="line">  request.ip = request.ips[<span class="number">0</span>] || req.socket.remoteAddress || <span class="string">''</span>;</div><div class="line"></div><div class="line">  <span class="comment">// 调用accepts</span></div><div class="line">  context.accept = request.accept = accepts(req);</div><div class="line"></div><div class="line">  <span class="comment">// 初始化state</span></div><div class="line">  context.state = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// 处理完毕后把ctx返回</span></div><div class="line">  <span class="keyword">return</span> context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里面用到了两个库<a href="https://github.com/pillarjs/cookies#readme" target="_blank" rel="external"><code>cookies</code></a>和<a href="https://github.com/jshttp/accepts#readme" target="_blank" rel="external">accepts</a>。前者就是用来操作<code>cookie</code>的，后者是处理<code>Negotiation</code>。</p>
<blockquote>
<p>TODO</p>
</blockquote>
<h3 id="respond"><a href="#respond" class="headerlink" title="respond"></a>respond</h3><p>koa在这里引入了<a href="https://github.com/jshttp/statuses#statuses" target="_blank" rel="external"><code>statuses</code></a></p>
<blockquote>
<p>HTTP status utility for node.</p>
</blockquote>
<p><code>statuses</code>提供了很多http状态的管理方法，平时处理http的时候会用得着。这里koa用来判断该请求是否需要把body清空，<a href="https://github.com/jshttp/statuses#statusemptycode" target="_blank" rel="external">比如这样</a>。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">status.empty[<span class="number">200</span>] <span class="comment">// =&gt; undefined</span></div><div class="line">status.empty[<span class="number">204</span>] <span class="comment">// =&gt; true</span></div><div class="line">status.empty[<span class="number">304</span>] <span class="comment">// =&gt; true</span></div></pre></td></tr></table></figure></p>
<p>接下来看本体。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">respond</span>(<span class="params">ctx</span>) </span>&#123;</div><div class="line">  <span class="comment">// 没有respond的话就不处理</span></div><div class="line">  <span class="keyword">if</span> (<span class="literal">false</span> === ctx.respond) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">  <span class="comment">// 把原生的res取出来</span></div><div class="line">  <span class="keyword">const</span> res = ctx.res;</div><div class="line"></div><div class="line">  <span class="comment">// 是否可写</span></div><div class="line">  <span class="keyword">if</span> (!ctx.writable) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">  <span class="comment">// 把body和状态码取出来</span></div><div class="line">  <span class="keyword">let</span> body = ctx.body;</div><div class="line">  <span class="keyword">const</span> code = ctx.status;</div><div class="line"></div><div class="line">  <span class="comment">// 判断该状态是否需要一个空的body</span></div><div class="line">  <span class="keyword">if</span> (statuses.empty[code]) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 把body清空</span></div><div class="line">    ctx.body = <span class="literal">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 返回</span></div><div class="line">    <span class="keyword">return</span> res.end();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果http的方法是 `HEAD`</span></div><div class="line">  <span class="keyword">if</span> (<span class="string">'HEAD'</span> == ctx.method) &#123;</div><div class="line">    <span class="keyword">if</span> (!res.headersSent &amp;&amp; isJSON(body)) &#123;</div><div class="line">      ctx.length = Buffer.byteLength(<span class="built_in">JSON</span>.stringify(body));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 返回</span></div><div class="line">    <span class="keyword">return</span> res.end();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// body为空</span></div><div class="line">  <span class="keyword">if</span> (<span class="literal">null</span> == body) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 把message或者状态码放进去</span></div><div class="line">    body = ctx.message || <span class="built_in">String</span>(code);</div><div class="line">    <span class="keyword">if</span> (!res.headersSent) &#123;</div><div class="line">      ctx.type = <span class="string">'text'</span>;</div><div class="line">      ctx.length = Buffer.byteLength(body);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 返回</span></div><div class="line">    <span class="keyword">return</span> res.end(body);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// responses</span></div><div class="line">  <span class="keyword">if</span> (Buffer.isBuffer(body)) <span class="keyword">return</span> res.end(body);</div><div class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> body) <span class="keyword">return</span> res.end(body);</div><div class="line">  <span class="keyword">if</span> (body <span class="keyword">instanceof</span> Stream) <span class="keyword">return</span> body.pipe(res);</div><div class="line"></div><div class="line">  <span class="comment">// 如果所有的判断都通过了，就当json来处理</span></div><div class="line">  body = <span class="built_in">JSON</span>.stringify(body);</div><div class="line">  <span class="keyword">if</span> (!res.headersSent) &#123;</div><div class="line">    ctx.length = Buffer.byteLength(body);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 返回</span></div><div class="line">  res.end(body);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里是<a href="https://nodejs.org/api/http.html#http_response_end_data_encoding_callback" target="_blank" rel="external"><code>res.end</code>的解释</a></p>
<blockquote>
<p>This method signals to the server that all of the response headers and body have been sent</p>
</blockquote>
<p><code>headersSent</code>和</p>
<h4 id="writable"><a href="#writable" class="headerlink" title="writable"></a>writable</h4><p><code>writable</code>是一个很有趣的变量，我们先找到<a href="https://github.com/koajs/koa/blob/13c7ca61392acecff026a079623ab0d928ea0d93/lib/response.js#L487-L505" target="_blank" rel="external">定义的地方</a>。</p>
<blockquote>
<p>can’t write any more after response finished</p>
</blockquote>
<p>防止在响应之后的再写入。</p>
<h3 id="koa-compose"><a href="#koa-compose" class="headerlink" title="koa-compose"></a>koa-compose</h3><p>首先<code>compose</code>把中间件处理了一下，看看他是如何实现的。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">'koa-compose'</span>);</div></pre></td></tr></table></figure></p>
<p>是一个独立的库。这里说一下，我们可以在命令行通过一个命令快速的找到一个库的实现。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> npm home koa-compose</div></pre></td></tr></table></figure></p>
<p>是不是很方便？我们把<a href="https://github.com/koajs/compose/blob/master/index.js" target="_blank" rel="external">定义的文件</a>打开看看。为了方便讲解，我把其中的注释和部分类型判断删掉了。</p>
<p>确保你对<code>Promise</code>已经很熟悉了，不然你会对接下里的讲解很困惑。</p>
<p>为了更好的理解下面的运行原理，先让我们复习一下koa的中间件运行顺序，只要弄明白下图是怎么回事就可以了。<br><img src="https://github.com/koajs/koa/blob/master/docs/middleware.gif" alt="middleware.gif"></p>
<p>很好，那我们开始。<br>噢，对，记得把它想象成洋葱。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span> (<span class="params">middleware</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// 首先会返回一个函数，就是createContext里的fn</span></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">context, next</span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 标识</span></div><div class="line">    <span class="keyword">let</span> index = <span class="number">-1</span></div><div class="line"></div><div class="line">    <span class="comment">// 调用第一个中间件，然后开始循环调用</span></div><div class="line">    <span class="keyword">return</span> dispatch(<span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 调用中间件</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">i</span>) </span>&#123;</div><div class="line"></div><div class="line">      <span class="comment">// 你不可以再一次请求里多次调用next</span></div><div class="line">      <span class="keyword">if</span> (i &lt;= index) <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'next() called multiple times'</span>))</div><div class="line"></div><div class="line">      <span class="comment">// 记录这是第几个中间件</span></div><div class="line">      index = i</div><div class="line"></div><div class="line">      <span class="comment">// 把中间件赋值为fn，这里可以知道，中间件的调用顺序取决于之前用use的顺序</span></div><div class="line">      <span class="keyword">let</span> fn = middleware[i]</div><div class="line"></div><div class="line">      <span class="comment">// 最后一次的时候，把next当成fn来处理，为了防止无限循环</span></div><div class="line">      <span class="comment">// https://github.com/koajs/compose/commit/2200a75657e1facd29718d84cf1e47677bfb6156</span></div><div class="line">      <span class="keyword">if</span> (i === middleware.length) fn = next</div><div class="line"></div><div class="line">      <span class="comment">// fn没有了的话，就是处理完毕了</span></div><div class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 循环调用，把标志加一，这样就会调用下一个中间件了</span></div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(context, <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</div><div class="line">        &#125;))</div><div class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>稀里糊涂的感觉？那就来看看<a href="https://github.com/koajs/compose/blob/master/test/test.js" target="_blank" rel="external">compose的单元测试</a>。一般对函数的定义理解不过来的时候，去翻一下注释是个很好的主意，测试里定义了函数的所有行为。</p>
<p>现在你可以感觉到，这个过程就是就是把一堆中间件给压缩成一个函数，用来处理网络请求。也就顺便弄清了中间件的整个处理过程。</p>
<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>koa的源码很精简，因为他把所有的额外功能都交给了其他的中间件，比如模板和路由。整个过程中，最有趣的部分莫过于中间件的处理。</p>
<p>感谢你的阅读 ：D</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nodejs/" rel="tag"># nodejs</a>
          
            <a href="/tags/koa/" rel="tag"># koa</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/06/axios发送formData/" rel="next" title="axios发送formData">
                <i class="fa fa-chevron-left"></i> axios发送formData
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/10/十月新番推荐/" rel="prev" title="十月新番推荐 - 少女终末旅行">
                十月新番推荐 - 少女终末旅行 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Limichange</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#说明"><span class="nav-number">1.</span> <span class="nav-text">说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#版本"><span class="nav-number">2.</span> <span class="nav-text">版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#首先"><span class="nav-number">3.</span> <span class="nav-text">首先</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#找入口"><span class="nav-number">4.</span> <span class="nav-text">找入口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构造函数"><span class="nav-number">5.</span> <span class="nav-text">构造函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#app-use"><span class="nav-number">6.</span> <span class="nav-text">app.use</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#app-listen"><span class="nav-number">7.</span> <span class="nav-text">app.listen</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createContext"><span class="nav-number">7.1.</span> <span class="nav-text">createContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#respond"><span class="nav-number">7.2.</span> <span class="nav-text">respond</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#writable"><span class="nav-number">7.2.1.</span> <span class="nav-text">writable</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#koa-compose"><span class="nav-number">7.3.</span> <span class="nav-text">koa-compose</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束"><span class="nav-number">8.</span> <span class="nav-text">结束</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Limichange</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://limichange.uedtoutiao.com/2017/10/06/看Koa的源码/';
          this.page.identifier = '2017/10/06/看Koa的源码/';
          this.page.title = '看Koa的源码';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://limichange.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.3"></script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
